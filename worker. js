export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    const path = url.pathname;

    if (path.startsWith("/search")) {
      const { date, dentist_id } = Object.fromEntries(new URLSearchParams(url.search));

      try {
        const slots = await env.DATABASE.prepare(`
          SELECT id, date, time, professional_id, patient_name, confirmed 
          FROM Appointments 
          WHERE date = ? AND professional_id = ? AND is_booked = 0`)
          .bind(date, dentist_id)
          .all();

        if (slots.results.length > 0) {
          return new Response(JSON.stringify({ available_slots: slots.results }), {
            headers: { "Content-Type": "application/json" },
          });
        } else {
          return new Response(JSON.stringify({ message: "No available slots found." }), {
            headers: { "Content-Type": "application/json" },
          });
        }
      } catch (error) {
        return new Response("Internal Server Error", { status: 500 });
      }
    }

    return new Response("Invalid Request", { status: 400 });
  }
};
